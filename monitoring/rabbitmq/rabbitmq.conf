# RabbitMQ Configuration for Bot Cluster Management

# Network settings
listeners.tcp.default = 5672
management.tcp.port = 15672

# TCP connection optimizations
num_acceptors.tcp = 10
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.keepalive = true
tcp_listen_options.send_timeout = 15000
tcp_listen_options.buffer = 196608
tcp_listen_options.sndbuf = 196608
tcp_listen_options.recbuf = 196608

# Socket writer optimization - reduce GC pauses
socket_writer.gc_threshold = 1000000000

# Handshake timeout optimization
handshake_timeout = 10000

# Memory and disk limits
vm_memory_high_watermark.relative = 0.7
disk_free_limit.relative = 2.0

# Use RSS for more accurate memory calculation (better than legacy)
vm_memory_calculation_strategy = rss

# Logging
log.console = true
log.console.level = info
log.file = true
log.file.level = info
# Note: rotation.date and rotation.size are mutually exclusive - using size-based rotation
log.file.rotation.size = 10485760
log.file.rotation.count = 5
log.file.rotation.compress = true

# Connection settings
heartbeat = 60
frame_max = 131072
initial_frame_max = 4096
channel_max = 2047
# Increase connection limits
vm_memory_high_watermark_paging_ratio = 0.5
# Optimize for many concurrent connections
num_acceptors.tcp = 20

# Queue settings
queue_leader_locator = balanced

# Cluster settings (for future scaling)
# Commented out for single-node setup - uncomment when adding additional nodes
# cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
# cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq

# Management plugin settings
# management.load_definitions = /etc/rabbitmq/definitions.json
# Note: Definitions are created dynamically by the application, no static file needed
management.tcp.max_keepalive = 120
management.tcp.idle_timeout = 120
management.tcp.inactivity_timeout = 120
management.tcp.request_timeout = 120
management.tcp.compress = true
# Use basic statistics mode for better performance (detailed is more resource-intensive)
management.rates_mode = basic

# Security settings
auth_mechanisms.1 = PLAIN
auth_mechanisms.2 = AMQPLAIN

# Performance settings
collect_statistics_interval = 5000

# Background GC optimization - balance between latency and memory usage
background_gc_enabled = true
background_gc_target_interval = 60000

# Queue index optimization - embed small messages directly
queue_index_embed_msgs_below = 4096

# Consumer timeout to prevent stuck consumers
consumer_timeout = 900000

# Reverse DNS lookups disabled for better connection performance
reverse_dns_lookups = false
